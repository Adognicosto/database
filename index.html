<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Prodotti</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; }
        .loader { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 1.2em; font-weight: 600; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .home-button { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .home-button:hover { background: rgba(255,255,255,0.3); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .tab-navigation { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab-button { flex: 1; padding: 20px; background: transparent; border: none; font-size: 18px; font-weight: 600; cursor: pointer; color: #6c757d; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button:hover { background: rgba(102,126,234,0.1); color: #667eea; }
        .tab-button.active { background: white; color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-container { padding: 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .search-box { position: relative; max-width: 800px; margin: 0 auto 20px; }
        .search-input { width: 100%; padding: 15px 50px 15px 20px; font-size: 16px; border: 2px solid #ddd; border-radius: 50px; outline: none; transition: all 0.3s ease; }
        .search-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 20px; }
        .search-hint { text-align: center; font-size: 13px; color: #6c757d; margin-top: 8px; font-style: italic; }
        .filters-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; max-width: 1200px; margin: 20px auto 0; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-select { padding: 10px 15px; font-size: 14px; border: 2px solid #ddd; border-radius: 8px; outline: none; background: white; cursor: pointer; transition: all 0.3s ease; }
        .filter-select:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .filter-select:hover { border-color: #667eea; }
        .results-info { padding: 20px 30px; background: #e7f3ff; border-bottom: 1px solid #bee5eb; display: none; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .results-info.show { display: flex; }
        .results-count { font-size: 1.1em; color: #004085; font-weight: 600; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; font-weight: 600; }
        .btn:hover { background: #5568d3; transform: scale(1.05); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-qr { background: #28a745; padding: 8px 16px; font-size: 13px; border-radius: 8px; }
        .btn-qr:hover { background: #218838; }
        .copy-btn { background: #667eea; color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; margin-left: 8px; transition: all 0.2s ease; font-weight: 600; }
        .copy-btn:hover { background: #5568d3; transform: scale(1.05); }
        .copy-btn:active { transform: scale(0.95); }
        .copied { background: #28a745 !important; }
        .table-container { padding: 30px; overflow: auto; max-height: 600px; }
        
        .welcome-message {
            text-align: center;
            padding: 80px 40px;
            color: #495057;
        }
        .welcome-message .icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .welcome-message h2 {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 15px;
        }
        .welcome-message p {
            font-size: 1.2em;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .welcome-message .tips {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }
        .welcome-message .tips h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .welcome-message .tips ul {
            list-style: none;
            text-align: left;
            display: inline-block;
        }
        .welcome-message .tips li {
            padding: 8px 0;
            font-size: 1.05em;
        }
        .welcome-message .tips li:before {
            content: "üîç ";
            margin-right: 10px;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; display: none; }
        table.show { display: table; }
        thead { position: sticky; top: 0; background: #667eea; color: white; z-index: 10; }
        th { padding: 12px 10px; text-align: left; font-size: 12px; text-transform: uppercase; white-space: nowrap; }
        td { padding: 12px 10px; border-bottom: 1px solid #e9ecef; font-size: 13px; vertical-align: middle; }
        tbody tr { transition: all 0.2s ease; }
        tbody tr:hover { background: #f8f9fa; transform: scale(1.002); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; font-weight: 600; }
        .desc-cell { max-width: 200px; word-wrap: break-word; white-space: normal; line-height: 1.4; }
        .empty-value { color: #999; font-style: italic; font-size: 12px; }
        .no-results { text-align: center; padding: 60px; color: #6c757d; display: none; }
        .no-results.show { display: block; }
        .no-results h3 { font-size: 1.5em; margin-bottom: 10px; }
        .active-filters { padding: 15px 30px; background: #fff3cd; border-bottom: 1px solid #ffc107; display: none; }
        .active-filters.show { display: block; }
        .filter-tag { display: inline-block; background: #667eea; color: white; padding: 5px 12px; border-radius: 15px; margin: 3px; font-size: 13px; cursor: default; }
        .filter-tag .remove { margin-left: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.2s ease; }
        .filter-tag .remove:hover { transform: scale(1.2); color: #ffdddd; }
        .db-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 10px; }
        .badge-margine { background: #d4edda; color: #155724; }
        .badge-standard { background: #cce5ff; color: #004085; }
        
        /* Modal QR Code */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal.show { display: flex !important; align-items: center; justify-content: center; }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }
        .modal-close:hover { color: #333; transform: scale(1.2); }
        .modal-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .modal-code {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }
        .modal-desc {
            font-size: 0.95em;
            color: #6c757d;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        .modal-qr {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            display: inline-block;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        .btn-print {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-print:hover { background: #5568d3; transform: scale(1.05); }
        .btn-download {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-download:hover { background: #218838; transform: scale(1.05); }
        
        @media (max-width: 768px) {
            .home-button { position: static; transform: none; margin-bottom: 10px; display: block; text-align: center; }
            .filters-container { grid-template-columns: 1fr; }
            .table-container { padding: 15px; }
            th, td { padding: 8px 6px; font-size: 11px; }
            .desc-cell { max-width: 150px; }
            .header h1 { font-size: 1.8em; }
            .welcome-message { padding: 40px 20px; }
            .welcome-message h2 { font-size: 1.5em; }
            .welcome-message p { font-size: 1em; }
            .modal-content { padding: 20px; max-width: 90%; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">‚è≥ Caricamento database...</div>
    </div>
    
    <!-- Modal QR Code -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-title">üì± QR Code Prodotto</div>
            <div class="modal-code" id="modalCode"></div>
            <div class="modal-desc" id="modalDesc"></div>
            <div class="modal-qr" id="modalQR"></div>
            <div class="modal-buttons">
                <button class="btn-print" onclick="printQR()">üñ®Ô∏è Stampa</button>
                <button class="btn-download" onclick="downloadQR()">üíæ Scarica</button>
            </div>
        </div>
    </div>
    
    <div id="mainContent" style="display:none;">
        <div class="container">
            <div class="header">
                <a href="index.html" class="home-button">üè† Home</a>
                <h1>üîç Database Prodotti</h1>
                <p>Sistema di ricerca avanzata con QR Code - 4004 prodotti</p>
            </div>
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('margine')">üì¶ IVA Margine <span class="db-badge badge-margine">1168</span></button>
                <button class="tab-button" onclick="switchTab('standard')">üìã IVA Standard <span class="db-badge badge-standard">2836</span></button>
            </div>
            <div id="tab-margine" class="tab-content active">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchMargine" class="search-input" placeholder="Cerca..." autocomplete="off">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="search-hint">üí° Cerca per codice, descrizione, frequenza, VGA - Clicca sul pulsante QR per generare il codice</div>
                    <div class="filters-container">
                        <div class="filter-group"><label class="filter-label">Dimensione</label><select id="fDimM" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">Memoria</label><select id="fMemM" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">HDD</label><select id="fHDDM" class="filter-select"><option value="">Tutti</option></select></div>
                        <div class="filter-group"><label class="filter-label">Processore</label><select id="fProcM" class="filter-select"><option value="">Tutti</option></select></div>
                        <div class="filter-group"><label class="filter-label">Frequenza</label><select id="fFreqM" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">VGA</label><select id="fVGAM" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">Colore</label><select id="fColM" class="filter-select"><option value="">Tutti</option></select></div>
                    </div>
                </div>
                <div class="active-filters" id="activeFiltersM"><strong>Filtri attivi:</strong> <span id="tagsM"></span></div>
                <div class="results-info" id="resultsInfoM">
                    <span class="results-count" id="countM">Totale: 1168 prodotti</span>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="resetM" style="display:none;">Reset</button>
                        <button class="btn" onclick="exportCSV('margine')">CSV</button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="welcome-message" id="welcomeMsgM">
                        <div class="icon">üîç</div>
                        <h2>Database IVA Margine</h2>
                        <p>Utilizza la ricerca o i filtri per visualizzare i prodotti</p>
                        <div class="tips">
                            <h3>üí° Come usare:</h3>
                            <ul>
                                <li>Cerca il prodotto usando la barra di ricerca</li>
                                <li>Clicca sul pulsante "üì± QR" per generare il QR code</li>
                                <li>Stampa o scarica il QR code per le etichette</li>
                                <li>1168 prodotti disponibili nel database</li>
                            </ul>
                        </div>
                    </div>
                    <table id="tableM">
                        <thead><tr><th style="width:8%;">AZIONE</th><th>COD</th><th>DESCRIZIONE</th><th>DIM</th><th>MEM</th><th>HDD</th><th>PROC</th><th>FREQ</th><th>VGA</th><th>COL</th></tr></thead>
                        <tbody id="bodyM"></tbody>
                    </table>
                    <div id="noResM" class="no-results"><h3>Nessun risultato</h3><p>Prova a modificare i filtri o la ricerca</p></div>
                </div>
            </div>
            <div id="tab-standard" class="tab-content">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchStandard" class="search-input" placeholder="Cerca..." autocomplete="off">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="search-hint">üí° Cerca per codice, descrizione, frequenza, VGA - Clicca sul pulsante QR per generare il codice</div>
                    <div class="filters-container">
                        <div class="filter-group"><label class="filter-label">Dimensione</label><select id="fDimS" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">Memoria</label><select id="fMemS" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">HDD</label><select id="fHDDS" class="filter-select"><option value="">Tutti</option></select></div>
                        <div class="filter-group"><label class="filter-label">Processore</label><select id="fProcS" class="filter-select"><option value="">Tutti</option></select></div>
                        <div class="filter-group"><label class="filter-label">Frequenza</label><select id="fFreqS" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">VGA</label><select id="fVGAS" class="filter-select"><option value="">Tutte</option></select></div>
                        <div class="filter-group"><label class="filter-label">Colore</label><select id="fColS" class="filter-select"><option value="">Tutti</option></select></div>
                    </div>
                </div>
                <div class="active-filters" id="activeFiltersS"><strong>Filtri attivi:</strong> <span id="tagsS"></span></div>
                <div class="results-info" id="resultsInfoS">
                    <span class="results-count" id="countS">Totale: 2836 prodotti</span>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="resetS" style="display:none;">Reset</button>
                        <button class="btn" onclick="exportCSV('standard')">CSV</button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="welcome-message" id="welcomeMsgS">
                        <div class="icon">üîç</div>
                        <h2>Database IVA Standard</h2>
                        <p>Utilizza la ricerca o i filtri per visualizzare i prodotti</p>
                        <div class="tips">
                            <h3>üí° Come usare:</h3>
                            <ul>
                                <li>Cerca il prodotto usando la barra di ricerca</li>
                                <li>Clicca sul pulsante "üì± QR" per generare il QR code</li>
                                <li>Stampa o scarica il QR code per le etichette</li>
                                <li>2836 prodotti disponibili nel database</li>
                            </ul>
                        </div>
                    </div>
                    <table id="tableS">
                        <thead><tr><th style="width:8%;">AZIONE</th><th>COD</th><th>DESCRIZIONE</th><th>DIM</th><th>MEM</th><th>HDD</th><th>PROC</th><th>FREQ</th><th>VGA</th><th>COL</th></tr></thead>
                        <tbody id="bodyS"></tbody>
                    </table>
                    <div id="noResS" class="no-results"><h3>Nessun risultato</h3><p>Prova a modificare i filtri o la ricerca</p></div>
                </div>
            </div>
        </div>
    </div>
    <script>
let dataMargine=[],dataStandard=[],currentTab='margine';
let currentQRCode = null;
let currentProduct = null;

async function loadData(){
    try{
        const[r1,r2]=await Promise.all([fetch('data_margine.json'),fetch('data_standard.json')]);
        dataMargine=await r1.json();
        dataStandard=await r2.json();
        document.getElementById('loadingScreen').style.display='none';
        document.getElementById('mainContent').style.display='block';
        populateFilters('margine',dataMargine);
        populateFilters('standard',dataStandard);
        setupEventListeners();
    }catch(e){
        console.error('Errore caricamento:', e);
        document.getElementById('loadingScreen').innerHTML='<div style="color:white;text-align:center;"><h2>‚ùå Errore</h2><p>File JSON non trovati</p></div>';
    }
}

function showQR(index, type) {
    try {
        const data = type === 'margine' ? dataMargine : dataStandard;
        const item = data[index];
        
        if (!item) {
            console.error('Prodotto non trovato:', index);
            return;
        }
        
        const cod = item.COD_VENDOR || '';
        const desc = item.DESCRIZIONE || '';
        
        currentProduct = { cod, desc };
        document.getElementById('modalCode').textContent = cod;
        document.getElementById('modalDesc').textContent = desc;
        
        const qrContainer = document.getElementById('modalQR');
        qrContainer.innerHTML = '';
        
        new QRCode(qrContainer, {
            text: cod,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        document.getElementById('qrModal').classList.add('show');
    } catch(e) {
        console.error('Errore generazione QR:', e);
        alert('Errore nella generazione del QR code');
    }
}

function closeModal() {
    document.getElementById('qrModal').classList.remove('show');
}

function printQR() {
    const printWindow = window.open('', '_blank');
    const qrImg = document.querySelector('#modalQR img').src;
    const cod = currentProduct.cod;
    const desc = currentProduct.desc;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Stampa QR Code - ${cod}</title>
            <style>
                body { font-family: Arial; text-align: center; padding: 20px; }
                h2 { margin: 10px 0; font-size: 24px; }
                p { margin: 10px 0; font-size: 14px; color: #666; }
                img { margin: 20px 0; border: 2px solid #333; }
            </style>
        </head>
        <body>
            <h2>${cod}</h2>
            <p>${desc}</p>
            <img src="${qrImg}" width="250" height="250">
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    setTimeout(() => {
        printWindow.print();
    }, 500);
}

function downloadQR() {
    const canvas = document.querySelector('#modalQR canvas');
    const link = document.createElement('a');
    link.download = currentProduct.cod + '_QR.png';
    link.href = canvas.toDataURL();
    link.click();
}

window.onclick = function(event) {
    const modal = document.getElementById('qrModal');
    if (event.target == modal) {
        closeModal();
    }
}

function setupEventListeners(){document.getElementById('searchMargine').addEventListener('input',()=>render('margine'));document.getElementById('fDimM').addEventListener('change',()=>render('margine'));document.getElementById('fMemM').addEventListener('change',()=>render('margine'));document.getElementById('fHDDM').addEventListener('change',()=>render('margine'));document.getElementById('fProcM').addEventListener('change',()=>render('margine'));document.getElementById('fFreqM').addEventListener('change',()=>render('margine'));document.getElementById('fVGAM').addEventListener('change',()=>render('margine'));document.getElementById('fColM').addEventListener('change',()=>render('margine'));document.getElementById('resetM').addEventListener('click',()=>reset('margine'));document.getElementById('searchStandard').addEventListener('input',()=>render('standard'));document.getElementById('fDimS').addEventListener('change',()=>render('standard'));document.getElementById('fMemS').addEventListener('change',()=>render('standard'));document.getElementById('fHDDS').addEventListener('change',()=>render('standard'));document.getElementById('fProcS').addEventListener('change',()=>render('standard'));document.getElementById('fFreqS').addEventListener('change',()=>render('standard'));document.getElementById('fVGAS').addEventListener('change',()=>render('standard'));document.getElementById('fColS').addEventListener('change',()=>render('standard'));document.getElementById('resetS').addEventListener('click',()=>reset('standard'))}

function switchTab(tab){currentTab=tab;document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active')}

function highlight(t,terms){if(!terms||!t)return t;let r=String(t);terms.forEach(term=>{const re=new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');r=r.replace(re,'<span class="highlight">$1</span>')});return r}

function populateFilters(type,data){const t=type==='margine'?'M':'S';const dims=[...new Set(data.map(i=>i.DIMENSIONE).filter(v=>v))].sort();const mems=[...new Set(data.map(i=>i.MEMORIA).filter(v=>v))].sort((a,b)=>parseInt(a)-parseInt(b));const hdds=[...new Set(data.map(i=>i.HDD).filter(v=>v))].sort((a,b)=>{const getSize=s=>{const m=s.match(/(\d+)\s*(GB|TB)/i);if(!m)return 0;return parseInt(m[1])*(m[2].toUpperCase()==='TB'?1024:1)};return getSize(a)-getSize(b)});const procs=[...new Set(data.map(i=>i.PROCESSORE).filter(v=>v))].sort();const freqs=[...new Set(data.map(i=>i.FREQUENZA).filter(v=>v))].sort((a,b)=>parseFloat(a)-parseFloat(b));const vgas=[...new Set(data.map(i=>i.VGA).filter(v=>v))].sort();const cols=[...new Set(data.map(i=>i.COLORE).filter(v=>v))].sort();const fill=(id,vals)=>{const sel=document.getElementById(id);sel.innerHTML='<option value="">Tutte</option>';vals.forEach(v=>{const opt=document.createElement('option');opt.value=v;opt.textContent=v;sel.appendChild(opt)})};fill('fDim'+t,dims);fill('fMem'+t,mems);fill('fHDD'+t,hdds);fill('fProc'+t,procs);fill('fFreq'+t,freqs);fill('fVGA'+t,vgas);fill('fCol'+t,cols)}

function removeFilter(type,key){const t=type==='margine'?'M':'S';const map={search:'search'+(type==='margine'?'Margine':'Standard'),dim:'fDim'+t,mem:'fMem'+t,hdd:'fHDD'+t,proc:'fProc'+t,freq:'fFreq'+t,vga:'fVGA'+t,col:'fCol'+t};const el=document.getElementById(map[key]);if(el){el.value='';render(type)}}

function render(type){
    const t=type==='margine'?'M':'S';
    const data=type==='margine'?dataMargine:dataStandard;
    const search=document.getElementById('search'+(type==='margine'?'Margine':'Standard')).value.toLowerCase().trim();
    const words=search?search.split(/\s+/).filter(w=>w):[];
    const fDim=document.getElementById('fDim'+t).value;
    const fMem=document.getElementById('fMem'+t).value;
    const fHDD=document.getElementById('fHDD'+t).value;
    const fProc=document.getElementById('fProc'+t).value;
    const fFreq=document.getElementById('fFreq'+t).value;
    const fVGA=document.getElementById('fVGA'+t).value;
    const fCol=document.getElementById('fCol'+t).value;
    
    const hasFilters=search||fDim||fMem||fHDD||fProc||fFreq||fVGA||fCol;
    const welcomeMsg=document.getElementById('welcomeMsg'+t);
    const resultsInfo=document.getElementById('resultsInfo'+t);
    const table=document.getElementById('table'+t);
    const noRes=document.getElementById('noRes'+t);
    
    if(!hasFilters){
        welcomeMsg.style.display='block';
        resultsInfo.classList.remove('show');
        table.classList.remove('show');
        noRes.classList.remove('show');
        document.getElementById('activeFilters'+t).classList.remove('show');
        return;
    }
    
    welcomeMsg.style.display='none';
    resultsInfo.classList.add('show');
    
    const filtered=data.filter(item=>{
        let match=true;
        if(words.length>0){
            const text=[item.COD_VENDOR||'',item.DESCRIZIONE||'',item.FREQUENZA||'',item.VGA||''].join(' ').toLowerCase();
            match=words.every(w=>text.includes(w));
        }
        if(match&&fDim&&item.DIMENSIONE!==fDim)match=false;
        if(match&&fMem&&item.MEMORIA!==fMem)match=false;
        if(match&&fHDD&&item.HDD!==fHDD)match=false;
        if(match&&fProc&&item.PROCESSORE!==fProc)match=false;
        if(match&&fFreq&&item.FREQUENZA!==fFreq)match=false;
        if(match&&fVGA&&item.VGA!==fVGA)match=false;
        if(match&&fCol&&item.COLORE!==fCol)match=false;
        return match;
    });
    
    const body=document.getElementById('body'+t);
    const count=document.getElementById('count'+t);
    const resetBtn=document.getElementById('reset'+t);
    const activeFilters=document.getElementById('activeFilters'+t);
    const tags=document.getElementById('tags'+t);
    
    count.textContent=`Trovati: ${filtered.length} prodotti`;
    resetBtn.style.display='inline-block';
    
    const activeTags=[];
    if(search)activeTags.push({label:'Ricerca',value:search,key:'search'});
    if(fDim)activeTags.push({label:'Dimensione',value:fDim,key:'dim'});
    if(fMem)activeTags.push({label:'Memoria',value:fMem,key:'mem'});
    if(fHDD)activeTags.push({label:'HDD',value:fHDD,key:'hdd'});
    if(fProc)activeTags.push({label:'Processore',value:fProc,key:'proc'});
    if(fFreq)activeTags.push({label:'Frequenza',value:fFreq,key:'freq'});
    if(fVGA)activeTags.push({label:'VGA',value:fVGA,key:'vga'});
    if(fCol)activeTags.push({label:'Colore',value:fCol,key:'col'});
    
    if(activeTags.length>0){
        activeFilters.classList.add('show');
        tags.innerHTML=activeTags.map(tag=>`<span class="filter-tag">${tag.label}: ${tag.value} <span class="remove" onclick="removeFilter('${type}','${tag.key}')">√ó</span></span>`).join('');
    }else{
        activeFilters.classList.remove('show');
    }
    
    if(filtered.length===0){
        body.innerHTML='';
        noRes.classList.add('show');
        table.classList.remove('show');
        return;
    }
    
    noRes.classList.remove('show');
    table.classList.add('show');
    
    body.innerHTML = filtered.map((item, idx) => {
        const originalIdx = data.indexOf(item);
        const sku = item.COD_VENDOR || '';
        const desc = item.DESCRIZIONE || '';
        return `<tr>
            <td><button class="btn btn-qr" onclick="showQR(${originalIdx}, '${type}')">üì± QR</button></td>
            <td><strong>${highlight(sku,words)}</strong><button class="copy-btn" onclick="copyTextFromData(${idx}, 'COD_VENDOR', '${type}')">Copia</button></td>
            <td class="desc-cell">${highlight(desc,words)}<button class="copy-btn" onclick="copyTextFromData(${idx}, 'DESCRIZIONE', '${type}')">Copia</button></td>
            <td>${item.DIMENSIONE||'-'}</td>
            <td>${item.MEMORIA||'-'}</td>
            <td>${item.HDD||'-'}</td>
            <td>${item.PROCESSORE||'-'}</td>
            <td>${highlight(item.FREQUENZA||'',words)||'-'}</td>
            <td>${highlight(item.VGA||'',words)||'-'}</td>
            <td>${item.COLORE||'-'}</td>
        </tr>`;
    }).join('');
    
    // Salvo i dati filtrati per il copy
    if (type === 'margine') {
        window.currentFilteredMargine = filtered;
    } else {
        window.currentFilteredStandard = filtered;
    }
}

function reset(type){const t=type==='margine'?'M':'S';document.getElementById('search'+(type==='margine'?'Margine':'Standard')).value='';document.getElementById('fDim'+t).value='';document.getElementById('fMem'+t).value='';document.getElementById('fHDD'+t).value='';document.getElementById('fProc'+t).value='';document.getElementById('fFreq'+t).value='';document.getElementById('fVGA'+t).value='';document.getElementById('fCol'+t).value='';render(type)}

function exportCSV(type){const data=type==='margine'?dataMargine:dataStandard;const headers=['COD_VENDOR','DESCRIZIONE','DIMENSIONE','MEMORIA','HDD','PROCESSORE','FREQUENZA','VGA','COLORE'];let csv=headers.join(',')+'\n';data.forEach(item=>{const row=headers.map(h=>'"'+(item[h]||'').toString().replace(/"/g,'""')+'"');csv+=row.join(',')+'\n'});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='prodotti_iva_'+type+'.csv';link.click()}

function copyText(text, button) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    const cleanText = tempDiv.textContent || tempDiv.innerText || text;
    
    navigator.clipboard.writeText(cleanText).then(() => {
        const originalText = button.textContent;
        button.textContent = '‚úì Copiato!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        alert('Errore durante la copia: ' + err);
    });
}

function copyTextFromData(index, field, type) {
    const data = type === 'margine' ? window.currentFilteredMargine : window.currentFilteredStandard;
    const item = data[index];
    const text = item[field] || '';
    
    navigator.clipboard.writeText(text).then(() => {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úì Copiato!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        alert('Errore durante la copia: ' + err);
    });
}

window.onload=loadData;
    </script>
</body>
</html>
